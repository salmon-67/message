<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Salmon Chat | Elite</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #0c0c0e; --bg-sidebar: #16161a; --bg-chat: #1c1c21;
            --bg-input: #27272e; --accent: #3b82f6; --text-main: #f4f4f5; --text-dim: #a1a1aa;
            --border: 1px solid rgba(255,255,255,0.08); --danger: #ef4444; --online: #22c55e;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        /* Layout: Lock to screen height */
        body { margin: 0; background: var(--bg-body); color: var(--text-main); height: 100dvh; display: flex; overflow: hidden; }
        #app-layout { display: none; width: 100%; height: 100%; overflow: hidden; }
        
        /* Panels */
        #sidebar-left { width: 260px; background: var(--bg-sidebar); border-right: var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        #main-chat { flex: 1; background: var(--bg-chat); display: flex; flex-direction: column; min-width: 0; height: 100%; }
        #sidebar-right { width: 220px; background: var(--bg-sidebar); border-left: var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        @media (max-width: 850px) { #sidebar-right { display: none; } }

        .header { height: 60px; display: flex; align-items: center; padding: 0 15px; border-bottom: var(--border); flex-shrink: 0; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        /* Chat Input */
        #input-area { padding: 15px; background: var(--bg-chat); border-top: var(--border); flex-shrink: 0; }
        .input-group { display: flex; gap: 10px; width: 100%; }
        input { flex: 1; padding: 12px; background: var(--bg-input); border: 1px solid transparent; color: white; border-radius: 10px; outline: none; }
        
        /* Buttons */
        .btn { padding: 10px 15px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .hidden { display: none !important; }

        /* Messages */
        .msg-row { display: flex; flex-direction: column; max-width: 85%; position: relative; }
        .msg-row.me { align-self: flex-end; align-items: flex-end; }
        .msg-name { font-size: 11px; color: var(--text-dim); margin-bottom: 3px; }
        .bubble { padding: 10px 14px; border-radius: 15px; background: var(--bg-input); font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .msg-row.me .bubble { background: var(--accent); color: white; border-bottom-right-radius: 2px; }
        
        /* Moderation Button */
        .delete-btn { position: absolute; top: 50%; right: -35px; transform: translateY(-50%); background:none; border:none; cursor:pointer; font-size:14px; display:none; }
        .msg-row:hover .delete-btn { display: block; }
        .msg-row.me .delete-btn { right: auto; left: -35px; }

        /* Sidebar Items */
        .channel-btn { padding: 10px; margin: 2px 10px; border-radius: 8px; cursor: pointer; color: var(--text-dim); font-size: 14px; }
        .channel-btn.active { background: var(--accent); color: white; font-weight: 700; }
        .member-item { padding: 8px 15px; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; }
        .status-dot.online { background: var(--online); box-shadow: 0 0 5px var(--online); }

        /* Modals */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .card { background: var(--bg-sidebar); border: var(--border); padding: 25px; border-radius: 20px; width: 100%; max-width: 400px; }
        .search-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 8px; }
    </style>
</head>
<body>

    <div id="login-overlay" class="overlay">
        <div class="card">
            <h2 style="text-align:center; color:var(--accent); margin-top:0;">SALMON</h2>
            <input type="text" id="login-user" placeholder="Username" style="width:100%; margin-bottom:10px;">
            <input type="password" id="login-pass" placeholder="Password" style="width:100%; margin-bottom:15px;">
            <button id="btn-auth" class="btn btn-primary" style="width:100%;">Enter Chat</button>
            <p id="auth-toggle" style="text-align:center; font-size:12px; cursor:pointer; color:var(--accent); margin-top:15px;">New? Register</p>
        </div>
    </div>

    <div id="app-layout">
        <nav id="sidebar-left">
            <div class="header" style="color:var(--accent); font-weight:800;">SALMON</div>
            <div style="flex: 1; overflow-y: auto;">
                <div style="padding: 15px 15px 5px; font-size: 11px; color: gray; font-weight: 800; text-transform: uppercase;">Channels</div>
                <div id="channel-list"></div>
            </div>
            <div style="padding: 15px; border-top: var(--border);">
                <input id="new-channel-input" placeholder="Channel Name" style="margin-bottom: 8px; font-size: 12px;">
                <button id="btn-create-channel" class="btn btn-primary" style="width:100%; font-size:12px;">Create Channel</button>
            </div>
            <div style="padding:15px; border-top:var(--border); font-size:12px; display:flex; justify-content:space-between; align-items:center;">
                <span id="my-name-display" style="font-weight:bold;"></span>
                <span id="btn-logout" style="color:var(--danger); cursor:pointer; font-weight:bold;">Logout</span>
            </div>
        </nav>

        <main id="main-chat">
            <header class="header">
                <div id="chat-title" style="flex:1; font-weight:bold;">Welcome</div>
                <div id="chat-actions" style="display:none; gap:10px;">
                    <button id="btn-trigger-add" class="btn btn-primary" style="font-size:11px; padding:6px 12px;">+ Add User</button>
                    <button id="btn-leave" class="btn-danger btn" style="font-size:11px; padding:6px 12px;">Leave</button>
                </div>
            </header>
            <div id="messages-box" class="scroll-area"></div>
            <div id="input-area" style="display:none;">
                <div class="input-group">
                    <input type="text" id="msg-input" placeholder="Message...">
                    <button id="btn-send" class="btn btn-primary">Send</button>
                </div>
            </div>
        </main>

        <aside id="sidebar-right">
            <div class="header" style="font-size:12px; color:gray; font-weight:800;">MEMBERS</div>
            <div id="member-list-box" style="flex:1; overflow-y:auto;"></div>
        </aside>
    </div>

    <div id="search-modal" class="overlay" style="display:none;">
        <div class="card">
            <h3 style="margin-top:0;">Search User</h3>
            <input type="text" id="search-query" placeholder="Username..." style="width:100%;">
            <div id="search-results-box" style="margin-top:10px; max-height:200px; overflow-y:auto;"></div>
            <button onclick="document.getElementById('search-modal').style.display='none'" class="btn" style="width:100%; background:none; color:gray; margin-top:10px;">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, updateDoc, arrayUnion, arrayRemove, where, limit, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBt0V_lY3Y6rjRmw1kVu-xCj1UZTxiEYbU",
            authDomain: "message-salmon.firebaseapp.com",
            projectId: "message-salmon",
            storageBucket: "message-salmon.firebasestorage.app",
            messagingSenderId: "538903396338",
            appId: "1:538903396338:web:325543bb4a2a08863ff56b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let activeChatId = null;
        let isRegisterMode = false;
        let msgUnsub = null;
        let sidebarUnsub = null;
        let memberUnsub = null;

        const getBadge = (user) => user?.admin ? "üõ†Ô∏è " : (user?.vip ? "‚ú® " : "");

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    currentUser = { id: user.uid, ...snap.data() };
                    await updateDoc(doc(db, "users", user.uid), { online: true });
                    await autoJoinAnnouncements();
                    document.getElementById('my-name-display').innerText = getBadge(currentUser) + currentUser.username;
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('app-layout').style.display = 'flex';
                    syncSidebar();
                }
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('app-layout').style.display = 'none';
            }
        });

        async function autoJoinAnnouncements() {
            const q = query(collection(db, "conversations"), where("name", "==", "Announcements"), limit(1));
            const snap = await getDocs(q);
            if (!snap.empty) {
                await updateDoc(doc(db, "conversations", snap.docs[0].id), { members: arrayUnion(currentUser.id) });
            }
        }

        // --- SIDEBAR (Admin Sees All) ---
        function syncSidebar() {
            if (sidebarUnsub) sidebarUnsub();
            const q = currentUser.admin 
                ? query(collection(db, "conversations"), orderBy("name", "asc"))
                : query(collection(db, "conversations"), where("members", "array-contains", currentUser.id));

            sidebarUnsub = onSnapshot(q, (snap) => {
                const box = document.getElementById('channel-list');
                box.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    const div = document.createElement('div');
                    div.className = `channel-btn ${activeChatId === d.id ? 'active' : ''}`;
                    const isGuest = currentUser.admin && !data.members.includes(currentUser.id);
                    div.innerText = "# " + data.name + (isGuest ? " (Guest)" : "");
                    div.onclick = () => openChat(d.id, data.name);
                    box.appendChild(div);
                });
            });
        }

        // --- CHAT LOGIC ---
        async function openChat(id, name) {
            if (msgUnsub) msgUnsub();
            activeChatId = id;
            document.getElementById('chat-title').innerText = "# " + name;
            
            const isAnn = name === "Announcements";
            const isAdmin = currentUser.admin === true;

            // Permissions Check
            document.getElementById('input-area').style.display = (isAnn && !isAdmin) ? 'none' : 'block';
            document.getElementById('btn-leave').classList.toggle('hidden', isAnn);
            document.getElementById('btn-trigger-add').classList.toggle('hidden', isAnn);
            document.getElementById('chat-actions').style.display = 'flex';

            syncSidebar();
            syncMembers(id);

            msgUnsub = onSnapshot(query(collection(db, "conversations", id, "messages"), orderBy("timestamp", "asc")), (snap) => {
                const box = document.getElementById('messages-box');
                box.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.senderId === currentUser.id;
                    const div = document.createElement('div');
                    div.className = `msg-row ${isMe ? 'me' : 'them'}`;
                    div.innerHTML = `
                        ${!isMe ? `<div class="msg-name">${m.senderBadge || ""}${m.senderName}</div>` : ""}
                        <div class="bubble">${m.content}</div>
                        ${isAdmin ? `<button class="delete-btn" data-id="${d.id}">üóëÔ∏è</button>` : ""}
                    `;
                    if (isAdmin) {
                        div.querySelector('.delete-btn').onclick = async () => {
                            if (confirm("Delete this message?")) await deleteDoc(doc(db, "conversations", id, "messages", d.id));
                        };
                    }
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        // --- ADD MEMBER LOGIC ---
        document.getElementById('search-query').oninput = async (e) => {
            const val = e.target.value.trim().toLowerCase();
            const box = document.getElementById('search-results-box');
            box.innerHTML = "";
            if (val.length < 2) return;

            const q = query(collection(db, "users"), where("username_lower", ">=", val), where("username_lower", "<=", val + '\uf8ff'), limit(5));
            const snap = await getDocs(q);

            snap.forEach(uDoc => {
                if (uDoc.id === currentUser.id) return;
                const u = uDoc.data();
                const div = document.createElement('div');
                div.className = "search-item";
                div.innerHTML = `<span>${getBadge(u)}${u.username}</span><button class="btn btn-primary" style="padding:5px 10px; font-size:10px;">ADD TO GROUP</button>`;
                div.querySelector('button').onclick = async () => {
                    await updateDoc(doc(db, "conversations", activeChatId), { members: arrayUnion(uDoc.id) });
                    alert("User Added!");
                    document.getElementById('search-modal').style.display = 'none';
                };
                box.appendChild(div);
            });
        };

        // --- GLOBAL EVENTS ---
        document.getElementById('btn-auth').onclick = async () => {
            const u = document.getElementById('login-user').value.trim().toLowerCase();
            const p = document.getElementById('login-pass').value;
            try {
                if (isRegisterMode) {
                    const res = await createUserWithEmailAndPassword(auth, `${u}@salmon.chat`, p);
                    await setDoc(doc(db, "users", res.user.uid), { username: u, username_lower: u, admin: false, vip: false, online: true });
                } else {
                    await signInWithEmailAndPassword(auth, `${u}@salmon.chat`, p);
                }
            } catch (e) { alert(e.message); }
        };

        document.getElementById('auth-toggle').onclick = () => {
            isRegisterMode = !isRegisterMode;
            document.getElementById('btn-auth').innerText = isRegisterMode ? "Register" : "Enter Chat";
        };

        document.getElementById('btn-send').onclick = async () => {
            const inp = document.getElementById('msg-input');
            if (!inp.value.trim()) return;
            const txt = inp.value; inp.value = "";
            await addDoc(collection(db, "conversations", activeChatId, "messages"), {
                content: txt, senderId: currentUser.id, senderName: currentUser.username, senderBadge: getBadge(currentUser), timestamp: serverTimestamp()
            });
        };

        document.getElementById('btn-trigger-add').onclick = () => { document.getElementById('search-modal').style.display = 'flex'; };
        document.getElementById('btn-logout').onclick = async () => {
            await updateDoc(doc(db, "users", currentUser.id), { online: false });
            signOut(auth);
        };
        document.getElementById('btn-create-channel').onclick = async () => {
            const name = document.getElementById('new-channel-input').value.trim();
            if (name.length < 2) return;
            await addDoc(collection(db, "conversations"), { name, members: [currentUser.id], createdAt: serverTimestamp() });
            document.getElementById('new-channel-input').value = "";
        };
        document.getElementById('btn-leave').onclick = async () => {
            await updateDoc(doc(db, "conversations", activeChatId), { members: arrayRemove(currentUser.id) });
            location.reload();
        };

        function syncMembers(chatId) {
            if (memberUnsub) memberUnsub();
            memberUnsub = onSnapshot(doc(db, "conversations", chatId), async (docSnap) => {
                const box = document.getElementById('member-list-box'); box.innerHTML = "";
                const memberIds = docSnap.data()?.members || [];
                for (const uid of memberIds) {
                    const uSnap = await getDoc(doc(db, "users", uid));
                    if (uSnap.exists()) {
                        const u = uSnap.data();
                        const div = document.createElement('div');
                        div.className = "member-item";
                        div.innerHTML = `<span class="status-dot ${u.online ? 'online' : ''}"></span> ${getBadge(u)}${u.username}`;
                        box.appendChild(div);
                    }
                }
            });
        }
    </script>
</body>
</html>
